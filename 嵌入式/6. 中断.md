# 中断的相关概念

计算机在执行程序过程中，当出现异常情况 (断电等) 或特殊请求 (数据传输等) 时，计算机暂停现行程序的运行，转向对这些异常情况或特殊请求进行处理，处理完毕后再返回到现行程序的中断处，继续执行原程序，这就是“中断”
- 中断是单片机实时处理内部或外部事件的一种机制
- 中断和异常其本质都是对主程序的“中断”

中断在嵌入式系统占有极其重要的地位，中断机制使得系统能更有效更合理地发挥效能和提高效率

### 中断处理流程

- 中断请求
  - 中断请求是中断源向 CPU 发出中断请求信号，此时中断控制系统的**中断请求寄存器**被置位，向 CPU 请求中断
- 中断响应
- 中断服务
- 中断返回

# STM32 中断和异常

## STM32 中断和异常向量表

当发生了异常或中断，内核要想响应这些异常或中断，就需要知道这些异常或中断的服务程序的**入口地址**，再由入口地址找到相应的中断服务程序，由中断入口地址组成的表称作中断向量表

## STM32 中断优先级

STM32 使用 Cortex-M3 的 8 位优先级寄存器中的 4 位来配置中断优先级，即 STM32 中的 NVIC **只支持 16 级中断优先级**的管理

中断分组管理参数表

| NVIC_PriorityGroup   | 抢占优先级取值范围     | 响应优先级取值范围 | 描述                                 |
| -------------------- | ---------------------- | ------------------ | ------------------------------------ |
| NVIC_PriorityGroup_0 | 0                      | 0 ~ 15             | 抢占优先级占 0 位，响应优先级占 4 位 |
| NVIC_PriorityGroup_1 | 0, 1                   | 0 ~ 7              | 抢占优先级占 1 位，响应优先级占 3 位 |
| NVIC_PriorityGroup_2 | 0, 1, 2, 3             | 0, 1, 2, 3         | 抢占优先级占 2 位，响应优先级占 2 位 |
| NVIC_PriorityGroup_3 | 0, 1, 2, 3, 4, 5, 6, 7 | 0, 1               | 抢占优先级占 3 位，响应优先级占 1 位 |
| NVIC_PriorityGroup_4 | 0 ~ 15                 | 0                  | 抢占优先级占 4 位，响应优先级占 0 位 |

### 中断优先级规则

- 高抢占优先级的中断可以打断低抢占优先级的中断服务，构成中断嵌套
- 中断优先级的数值越小，优先级级别越高
- 抢占优先级的优先级总是高于响应优先级
- 先判断抢占优先级的大小，如果抢占优先级相同，则比较响应优先级的大小，若抢占优先级和响应优先级均相同，则根据中断向量表中的顺序来决定
- Reset NMI Hard Fault 的优先级为负，且不可修改，高于普通的中断优先级

## STM32 中断服务程序

STM32 将中断服务程序统一放在标准外设库 stm32f10x_it.c 文件中，其中的每个中断服务函数都只有函数名，函数体都是空的，需要用户自己编写相应的函数体，但中断服务程序的函数名是不能更改的

# STM32 外部中断 EXTI

支持 19 个外部中断/事件请求，每个中断/事件都有独立的触发和屏蔽设置，具有中断模式和事件模式两种设置模式

STM32 芯片之外的外设的中断 (I/O 端口) 由 EXTI 和 NVIC 共同实现，即每一个 STM32 的 GPIO 引脚都可以配置成一个**外部中断触发源**

> [!NOTE]
> EXTI: 外部中断/事件控制器

## 设置模式

- 中断模式
  - 通过外部信号的边沿产生中断信号传送给 NVIC，触发中断，最终实现中断服务程序的执行
  - 由软件实现相应功能
- 事件模式
  - 产生脉冲将系统从睡眠和停止模式中唤醒，从而产生相应外设的触发信号供外设电路使用
  - 事件属于硬件触发执行的过程

总结：中断模式主要用于软件中断处理，而事件模式主要用于硬件唤醒和触发外设

## EXTI 外部中断线

STM32 中，每一个 GPIO 都可以触发一个外部中断

- 线 0~15
  - 对应 I/O 引脚的外部中断
- 线 16
  - 连接到 PVD 输出
- 线 17
  - 连接到 RTC 闹钟事件
- 线 18
  - 连接到 USB 唤醒事件

> [!NOTE]
> PVD: 可编程电压检测器
>
> RTC: 实时时钟

## GPIO 中断特性

GPIO 的中断是以组为单位的，同组的外部中断共用一条外部中断线

例如：PA0、PB0、PC0、PD0、PE0、PF0、PG0 这些为一组，如果使用 PA0 作为外部中断源，那么 PB0、PC0、PD0、PE0、PF0、PG0 就不能同时再作为外部中断使用了，在此情况下，只能使用类似于 PB1、PC2 这种末端序号不同的外部中断源

# EXTI 模块的 HAL 库接口函数及应用

略
