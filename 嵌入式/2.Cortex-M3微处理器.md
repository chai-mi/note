# 内核结构

## 概述

- 哈佛结构
- 三级流水线
- ARMv7 架构
- 32 位处理器内核
- 指令总线和数据总线共享同一个存储器空间，寻址能力为 4 G
- Thumb-2 指令集 (16 位、32 位混合指令集)

## 三级流水线

每条指令分解为多步，并让各步操作重叠，从而实现几条指令并行处理的技术，称为流水线技术
- 取指 (FI): 将指令从存储器中取出
- 译码 (DI): 对所取到的指令进行翻译
- 执行 (EI): 执行指令

### 吞吐率

单位时间内流水线所完成的指令数或输出结果的数量

$$
吞吐率 = \frac{指令条数}{指令流水线所需时间}
$$

$$
流水线执行 n 条指令所需时间 = 完成一条指令所需时间 + (指令条数 n-1) \times 时间最长的指令段
$$

### 加速比

完成一批任务不使用流水线时间和使用流水线所用时间之比

若流水线各段的时间均为 $\Delta t$，流水线级数为 $m$,采用流水线方式完成 $n$ 条指令共需 $m \Delta t+(n-1) \Delta t$ 时间，而不采用流水线方式完成 $n$ 条指令所需时间为 $nm \Delta t$，则加速比为

$$
S_p=\frac{nm \Delta t}{m \Delta t + (n-1) \Delta t}
$$

## 系统总线

计算机系统中，各个部件之间传送信息的公共通路叫总线
- 数据总线
- 地址总线
- 控制总线

AMBA 是 1996 年由 ARM 公司研发推出的一种高级微控制器总线架构

### AMBA 包含了四种不同的总线标准

- AHB (Advanced High-performance Bus) 高级高性能总线
  - 用于高性能模块之间的连接，可以连接多个主机和多个从机
- APB (Advanced Peripheral Bus) 高级外设总线
  - 是一种低成本、低功耗、结构简单的低速通信总线
  - APB 总线通信有主从设备之分，APB 主设备通常是 APB 桥，从设备通常是一些低速的外设
- ~~ASB (Advanced System Bus) 高级系统总线~~
- ~~AXI (Advanced eXtensible Interface) 高级可拓展接口~~

### Cortex-M3 总线结构

- I-Code 指令总线
  - 基于 AHB-Lite 总线协议的 32 位总线
  - 用于取指操作
- D-Code 数据总线
  - 基于 AHB-Lite 总线协议的 32 位总线
  - 用于数据访问操作
- 系统总线
  - 基于 AHB-Lite 总线协议的 32 位总线
  - 用于访问内存和外设
- 外设总线
  - 基于 APB 总线协议的 32 位总线
  - 用于访问私有外设

## 寄存器

- 13 个 32 位的通用寄存器 R0~R12
- R0‐R7 也被称为低组寄存器，所有指令都能访问它们
- R8‐R12 也被称为高组寄存器，只有很少 16 位 Thumb 指令能访问它们，32 位的指令则不受限制
- R13、R14、R15 三个寄存器被指定了专门的用途

## 存储结构

ARM Cortex-M3 系列微处理器采用存储器与 I/O 设备 (外设) 统一编址的方式，设置部分存储器地址范围用于外设的访问

将这种通过存储器地址访问外设的方式，称为存储器地址映射

## 工作模态

| 工作模式                           | 特权等级 |
| ---------------------------------- | -------- |
| 非异常状态 线程模式 (thread mode)  | 用户级   |
| 非异常状态 线程模式 (thread mode)  | 特权级   |
| 异常状态 处理者模式 (handler mode) | 特权级   |

特权等级是对存储器访问提供的一种保护机制
- 在特权级下，程序可以访问所有范围的存储器，并且能够执行所有指令
- 用户级下，不能访问系统控制空间 (包含配置寄存器及调试组件的寄存器)，且禁止使用 MSR 访问特殊功能寄存器 (APSR 除外)，如果访问，则产生 fault

> [!NOTE]
> MSR: 机器状态寄存器

## 中断

- 事件 (event): 触发系统某种行为的消息或请求，由某个对象发出，并由某个对象接收和处理
- 异常 (exception): 为打断程序正常执行顺序的事件
- 中断 (Interrupt): 一般指来自外部的片上外设或外扩的外设的中断请求事件

### Cortex-M3 内核可支持 256 种异常和中断

- 中断编号 1~15 为系统异常
- 大于等于 16 的则全是外部中断，共 240 个外部中断
通常外部中断写作 IRQs，Cortex-M3 具有 256 级的可编程中断优先级设置，功能十分强大

### 中断的作用和意义

- 实时控制: 中断允许系统在确定的时间内对特定事件作出及时响应，这对于实时控制系统非常关键
- 故障处理: 中断机制允许系统检测到故障并迅速作出响应
- 数据传输: 对于异步事件，如数据传输，中断可以在数据到达时通知系统，并立即处理接收到的数据
- 高效处理紧急程序: 中断允许处理紧急程序而不需要等待当前任务的完成
- 不占用 CPU 资源: 中断允许系统在等待事件发生的同时执行其他任务，而不会一直占用 CPU 资源

Cortex-M3 内核集成了一个外设 NVIC (Nested Vectored Interrupt Controller) 用于专门负责中断

### NVIC 具有以下特性

- 可嵌套中断支持，即高优先级的中断可以打断低优先级的中断
- 向量中断支持，缩短中断延迟时间
- 动态优先级调整支持。软件可以在运行期间更改中断的优先级
- 中断延迟大大缩短
- 中断可屏蔽

### 响应中断的过程

1. 保存现场
2. 取向量
3. 更新寄存器

### 中断悬起

如果中断发生时，正在处理同级或高优先级异常，或者被掩蔽 (primask、faultmask、basepri 中断屏蔽寄存器)，则中断不能立即得到响应，此时中断被悬起

### 中断活跃

当某中断的服务例程开始执行时，中断进入活跃状态，其悬起位被硬件清除，中断退出后才能对该中断的新请求予以响应，同时硬件清除活跃标志位

### 中断请求信号保持

如果中断源咬住请求信号不放，该中断就会在其上次服务例程返回后再次被置为悬起状态

## 调试与跟踪

CoreSight 调试架构包括
- 调试接口协议
- 调试总线协议
- 对调试组件的控制
- 安全特性
- 跟踪接口

### 调试访问端口 (Debug Access Port, DAP)

- 用于 Cortex-M3 调试系统对处理器上总线逻辑的控制
- 通过把联合测试工作组 (JTAG) 或串行线 (SW) 协议都转换成 DAP 总线接口协议，再控制 DAP 来执行调试动作。DAP 总线与 APB 总线很相似，很容易地连接其他调试组件，把调试接口和调试硬件分开，使得调试系统规模可调整，伸缩性很强

### 调试端口 (Debug Port, DP)

充当处理器与调试器的中介，它的一横连接到调试器上，另一端则连接到 Cortex-M3 的 DAP 接口上

常见调式端口
- JTAG
- SW

| 侵入式调试                                           | 非侵入式调试                                  |
| ---------------------------------------------------- | --------------------------------------------- |
| 停机以及单步执行程序                                 | 在内核运行的时候访问存储器                    |
| 硬件断点                                             | 指令跟踪需要通过可选的嵌入式跟踪宏单元 ETM    |
| 断点指令 BKPT                                        | 数据跟踪                                      |
| 数据观察点作用于单一地址、一个范围的地址以及数据的值 | 软件跟踪通过 ITM 指令跟踪单元                 |
| 访问寄存器的值既包括读也包括写                       | 性能速写 profiling 通过数据观察点以及跟踪模块 |
| 调试监视器异常                                       |                                               |
| 基于 ROM 的调试闪存地址重载 (flash patching)         |                                               |

### 跟踪接口

CoreSight 架构还可以用于数据跟踪。跟踪源产生的数据被封装成数据包，数据包长度可变。这些包通过“高级跟踪总线” (ATB) 送往 TPIU (跟踪端口接口单元)，由 TPIU 把它们格式化，转换成符合“跟踪总线接口协议”的数据包，再把数据导出到片外的跟踪硬件设备
