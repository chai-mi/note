# ADC 基础理论知识

## A/D 转换过程

ADC (Analog to Digital Converter) 即模数转换器, 用来将模拟信号转换为数字信号

### Nyquist–Shannon (奈奎斯特 - 香农) 采样定理

为了不失真地恢复模拟信号, 采样频率应该**不小于**模拟信号频谱中最高频率的 2 倍

## A/D 转换的主要技术参数

### 转换精度

- 分辨率
  - A/D 转换器对输入模拟量微小变化的分辨能力, 通常用二进制数的有效位表示
- 转换误差
  - 由于 A/D 转换器的有限分辨率而引起的误差, 反映 A/D 转换器实际输出数字量和理想输出之间的差异

| 位数 | 级数             | 分辨率 (参考电压 10V) |
| ---- | ---------------- | --------------------- |
| 8    | $2^{8} = 256$    | 39.1 mV               |
| 10   | $2^{10} = 1024$  | 9.77 mV               |
| 12   | $2^{12} = 4096$  | 2.44 mV               |
| 14   | $2^{14} = 16384$ | 0.61 mV               |
| 16   | $2^{16} = 65536$ | 0.15 mV               |

> [!NOTE]
> - 8 位、12 位 ADC 常用于工控领域、语音处理领域
> - 16 位或更高的 ADC 常用于医学领域中微弱生理信号的采集

### 转换速度

- 转换时间
  - 指从转换控制信号到来到 A/D 转换器输出端得到稳定的数字量所需要的时间
- 转换速率
  - 转换时间的倒数

#### 转换时间与 A/D 转换器类型有关

- 双积分型 A/D 转换器的转换时间一般在几十毫秒数量级, 属于低速 A/D 转换器
- 逐次逼近型在几十微秒, 属于中速 A/D 转换器
- 并行比较型一般在几十纳秒

# STM32 的 ADC 模块

- 集成有三个 12 位逐次逼近型的 A/D 转换器
- 转换结果是一个 12 位的二进制数, 可以以左对齐或右对齐两种方式存储在 16 位数据寄存器中
- 多达 18 个通道, 可实现 16 个外部模拟输入通道和 2 个内部信号源的 A/D 转换
- 各通道的 A/D 转换器可采用的执行模式
  - 单次: ADC 只执行一次转换
  - 连续: 当前 ADC 转换一结束就会立即启动下一个转换
  - 扫描: 扫描一组模拟通道并转换
    - 单次模式: 扫描完本组所有通道后, ADC 自动停止
    - 连续模式: 扫描完本组所有通道后, 再从第一个通道继续扫描
  - 间断: 用于多个通道的规则组和注入组

### 间断模式

- 当以间断模式转换一个规则组时, 转换序列结束后不自动从头开始
- 当所有子组被转换完成, 下一次触发启动第一个子组的转换
- 规则组和注入组不能同时设置为间断模式

<details>

<summary>例题</summary>

以规则组为例, 若被转换的通道为 0、1、2、3、6、7、9、10, n=3, 则

- 第一次触发: 进行转换的通道序列为 0、1、2
- 第二次触发: 进行转换的通道序列为 3、6、7
- 第三次触发: 进行转换的通道序列为 9、10, 并产生 EOC 事件
- 第四次触发: 进行转换的通道序列 0、1、2

</details>

## ADC 通道选择

按组进行转换的模式, 可以由程序设置实现对多个模拟通道自动地进行逐个采样转换

### STM32 分为两种组转换模式

- 规则组
  - 规则通道组最多允许 16 个规则通道进行转换
  - 可通过编程来设定规则通道的数量 n, n 最多可设定为 16
  - 转换结果保存在同一个 16 位的规则通道数据寄存器 ADC_DR 中, 同时, EOC 标志被置位, 产生相应的中断或 DMA 请求
- 注入组
  - 最多允许 4 个通道进行转换, 并且对应有 4 个注入通道寄存器用来存放注入通道的转换结果, 因此注入通道组没有 DMA 请求
  - 注入通道组的触发转换序列和规则通道一样
  - 转换结果保存数据寄存器 ADC_JDRx 中, 同时产生 ADC 注入转换结束事件, 即 JEOC 标志被置位, 产生相应的中断
  - 规则通道组转换好比是程序的正常执行, 注入通道组的转换则好比是一个中断处理程序

### 规则组和注入组的关键区别

| 特性     | 规则组                           | 注入组                       |
| -------- | -------------------------------- | ---------------------------- |
| 优先级   | 低                               | 高                           |
| 通道数量 | 最多 16                          | 最多 4                       |
| 触发机制 | 多种, 包括软件、定时器、外部事件 | 通常为外部事件, 也可软件触发 |
| 数据存储 | ADC_DR                           | ADC_JDRx                     |
| 中断     | EOC                              | JEOC                         |
| DMA 请求 | 有                               | 无                           |

## ADC 中断和 DMA 请求

ADC 转换的触发信号的产生方式
- 软件触发转换
  - 由软件编程控制, 使能触发启动位
- 外部触发
  - 规则通道组的外部触发源可以是定时器的 TIM1_CH1~TIM1_CH3, 或者由外部中断线 EXTI_11 触发
  - 注入组的外部触发源可以是定时器的 TIM1_CH4, 或者外部中断线 EXTI_15 触发

ADC 在每个通道转换完成后, 可产生相应的中断请求
- 对于规则通道, 如果 ADC_CR1 寄存器的 EOCIE 位被置 1, 则会产生 EOC 中断
- 对于注入通道, 如果 ADC_CR1 寄存器的 JEOCIE 位被置 1, 则会产生 JEOC 中断
- ADC1 和 ADC3 的规则通道转换完成后还可产生 DMA 请求

| 中断事件                       | 事件标志                            | 使能控制位 |
| ------------------------------ | ----------------------------------- | ---------- |
| 规则组转换结束中断 ADC_IT_EOC  | EOC 中断 End of Coversion           | EOCIE      |
| 注入组转换结束中断 ADC_IT_JEOC | JEOC 中断 End of injected Coversion | JEOCIE     |
| 模拟看门狗中断 ADC_IT_AWD      | AWD 中断 Analog WatchDOG            | AWDIE      |

### DMA 请求

- 适用情况: 只有 ADC1 和 ADC3 能产生 DMA 请求, ADC2 转换数据可以在双 ADC 模式中使用 ADC1 的 DMA 请求
- 使用原因: 规则通道的转换只有一个数据寄存器 ADC_DR, 每个通道转换完成后, 将覆盖以前的数据, 所以可以使用 DMA 方式处理数据及时地将已完成转换的数据读出
- 应用: 在每次产生转换结束事件 EOC 标志后, DMA 控制器会把保存在 ADC_DR 寄存器中的规则组通道的转换数据传送到 SRAM 中 (用户指定的目标地址)

## ADC 转换时间

STM32 的 ADC 的采样时间可选择为采样周期的 1.5、7.5、13.5、28.5、41.5、55.5、71.5 或 239.5 倍

ADC 总的转换时间可以表示为

$$
ADC 总的转换时间 = (采样周期倍数 + 12.5) \times 一个周期的时间
$$

> [!TIP]
> ADC 的时钟 ADCCLK 最大不能超过 14 MHz, 因此 STM32F103 系列微控制器的 ADC 最短转换时间为 $1 \mu s$

<!-- 由于 GitHub 的 BUG, 在此处折叠例题会导致下面的公式无法正常渲染 -->
<!-- 似乎由上面的 表格, [!NOTE], [!TIP], 和公式 引起 -->
### 例题

如果 ADCCLK=14 MHz, 采样时间为 1.5 个周期, 则

$$
总的转换时间 = (1.5+12.5)/14 MHz=1\mu s
$$

## ADC 数据对齐

一般建议采用右对齐, 因为数据传输一般是从最低位开始 (也即右边开始), 如果数据位是从高位开始传输的, 可以采用左对齐方式

## ADC 校准

- 目的: A/D 转换过程需要一定的转换时间, 对 ADC 进行校准可以减少因内部电容的变化而导致的误差
- 实现: STM32 的 ADC 具有内置的自校准模式, ADC 在上电后至少 2 个 ADC 时钟周期才能开始校准
- 要求: 建议每次上电后都执行一次 ADC 校准, 以保证采集数据的准确性

# ADC 模块的标准外设库接口函数及应用

略

# ADC 模块的 HAL 库接口函数及应用

略
