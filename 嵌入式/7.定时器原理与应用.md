# STM32 定时器模块

### STM32 定时器家族

- 外设定时器
  - 常规定时器
    - 高级定时器
    - 通用定时器
    - 基本定时器
  - 专用定时器
    - 看门狗定时器
    - 实时时钟
    - 低功耗定时器
- 核内定时器
  - 系统节拍定时器

### WatchDog 看门狗

当微控制器受到外部干扰或程序中出现不可预知的逻辑故障导致应用程序脱离正常的执行流程时 (俗称程序跑飞)，在一定的时间间隔内使系统复位，回到初始状态

看门狗设计是用来监视 MCU 程序运行状态的，是确保系统可靠稳定运行的一种有效措施

- 独立看门狗 IWDG
  - 采用独立时钟，不受其他时钟和总线影响，可在停机和待机模式下工作
  - 适用于独立于主程序之外、能够独立工作且对时间精度要求不高的场合
- 窗口看门狗 WWDG
  - 计数值有一个上限时间和下限时间，低于下限时间或高于上限时间都会触发 MCU 复位
  - 适用于精确计时窗口起作用的应用程序

### STM32 定时器分类比较表

| 定时器          | 基本定时器 (TIM6、TIM7) | 通用定时器 (TIM2、TIM3、TIM4、TIM5)                        | 高级定时器 (TIM1、TIM8)      |
| --------------- | ----------------------- | ---------------------------------------------------------- | ---------------------------- |
| 计数器类型      | 16 位，向上             | 16 位，向上、向下、向上/向下                               | 16 位，向上、向下、向上/向下 |
| 预分频系数      | 1~65535 之间的任意数    | 1~65535 之间的任意数                                       | 1~65535 之间的任意数         |
| 输入/捕获通道   | 无                      | 四个独立通道：输入捕获、输出比较、PWM 生成、单脉冲模式输出 | 同左                         |
| 产生中断/DMA    | 可以                    | 可以                                                       | 可以                         |
| 刹车 (电机控制) | 无                      | 无                                                         | 可以                         |

### 定时器主要功能

- 计数
  - 脉冲计数，使用微控制器内部的外部时钟（PCLK）来计数，是对固定周期的脉冲信号计数
- 定时
  - 时间控制，通过对微控制器内部的时钟脉冲进行计数实现定时功能
- 输入捕获
  - 对输入信号进行捕获，实现对脉冲的频率测量，可用于对外部输入信号脉冲宽度的测量，比如测量电机转速
- 输出比较
  - 将计数器计数值和设定值进行比较，根据比较结果输出不同电平，用于控制输出波形，比如直流电机的调速

## 通用定时器

TIM2、TIM3、TIM4、TIM5 为 STM32 的 4 个独立的 16 位通用定时器，具有定时、测量输入信号的脉冲长度 (输入捕获)、输出所需波 (输出比较、产生 PWM、单脉冲输出等) 等功能

主要由时钟源、时钟单元、捕获和比较通道等构成，核心是可编程预分频驱动的 16 位自动重载计数器

### 时钟源

当定时器使用内部时钟时，定时器的时钟源统称为 TIMxCLK。虽然在系统默认的配置中，TIMxCLK 的时钟频率都是 72 MHz，但其时钟来源并不相同
- 定时器 TIM2~TIM7 挂接在 APB1 上
- 定时器 TIM1 和 TIM8 挂接在 APB2 上

若外部晶振的频率为 8 MHz，则系统默认的时钟频率为 72 MHz
- APB1 预分频器的分频系数设置为 2，则 $PCLK1 = 36 MHz$
- APB2 预分频系数设置为 1，则 $PCLK2 = 72 MHz$，TIM1 和 TIM8 的时钟频率 $TIMxCLK = 72 MHz$
- Cortex 系统时钟由 AHB 时钟 (HCLK) 8 分频得到，即 SysTick 的频率为 9 MHz

### 预分频器 PSC (Prescaler)

可以以 1～65535 之间的任意数值对时钟源 CK_PSC 的时钟频率进行分频，输出 CK_CNT 脉冲供计数器 CNT 进行计数

### 计数器 CNT (Counter)

- TIMxCNT 是一个 16 位的寄存器，计数范围为 1～65535，可以向上计数、向下计数或向下向上双向计数
- 要得到想要的计数值，需要对输入时钟频率进行分频
- 当计数值达到设定值时，便产生溢出事件，溢出时产生中断或 DMA 请求，然后再由自动重载寄存器进行重新加载或更新
- 计数器溢出中断属于软件中断，执行相应的定时器中断服务程序

### 自动重载寄存器 ARR

定时器的定时时间主要取决于定时周期和预分频因子，计算公式为

$$
定时时间=(ARR+1)\times(预分频值 PSC+1)/输入时钟频率
$$

或

$$
T=(TIM_{Period} + 1)\times(TIM_{Prescaler} + 1)/ TIMxCLK
$$

这里 ARR + 1 是因为计数器都是从 0 开始计数的

## 基本定时器

STM32 有 2 个基本定时器 TIM6 和 TIM7，可用作
- 通用的 16 位计数器
- 产生 DAC 触发信号

基本定时器的计数模式只有向上计数模式

> [!NOTE]
> DAC: 数模转换器

## 高级定时器

TIM1 和 TIM8 是 STM32 的 2 个 16 位的高级定时器

### 作用

- 通用定时功能
- TIM1 还提供控制三相六步电机的接口，具有刹车、死区时间控制等功能，主要用于电机控制

# PWM

> [!NOTE]
> PWM: Pulse Width Modulation，脉冲宽度调制

是一种利用脉冲宽度即占空比实现对模拟信号进行控制的技术，即是对模拟信号电平进行数字表示的方法

广泛应用于电力电子技术中
- 逆变电路
- 直流电机调速
  - 变频空调的交直流变频调速
  - 除实现调速外，还具有节能等特性

## 占空比 (Duty Cycle)

是指在一个周期内，高电平时间占整个信号周期的百分比，即高电平时间与周期的比值
$$
占空比=T_p/T
$$

## STM32 定时器 PWM 的工作原理

- STM32 的定时器除了 TIM6 和 TIM7，其他定时器都可以用来产生 PWM 输出
- 高级定时器 TIM1 和 TIM8 可以同时产生多达 7 路的 PWM 输出
- 通用定时器能同时产生多达 4 路的 PWM 输出
- STM32 中每个定时器有 4 个输入通道：TIMx_CH1~TIMx_CH4
- 每个通道对应 1 个捕获/比较寄存器 TIMx_CCRx，将寄存器值和计数器值相比较，通过比较结果输出高低电平，从而得到 PWM 信号
- 脉冲宽度调制模式可以产生一个由 TIMx_ARR 寄存器确定频率、由 TIMx_CCRx 寄存器确定占空比的信号

# SysTick 定时器

Cortex-M3 内核中的 SysTick 定时器，是一个 24 位的从重载值向下递减到 0 的计数器，是 NVIC 的一部分，根植于 NVIC

常用于精确定时，为操作系统提供必要的时钟节拍，为 RTOS 的任务调度提供一个有节奏的“心跳”

> [!NOTE]
> RTOS: 实时操作系统

SysTick 定时器一共有四个寄存器
- SysTick 控制及状态寄存器 CTRL
- SysTick 重装载数值寄存器 LOAD
- SysTick 当前数值寄存器 VAL
- SysTick 校准数值寄存器 CALIB (Calibration)

SysTick 定时器的时钟源可以是内部时钟 (FCLK) 或者是外部时钟，系统默认的 SysTick 定时器是由 AHB 时钟 (HCLK) 8 分频得到的，即 SysTick 的频率为 9 MHz。SysTick 定时器从设定的初值计数到 0 时，会自动重装初值继续计数，同时触发中断，因此，只需确定计数的次数就可以精确得到延迟时间

# 定时器模块的 HAL 库接口函数及应用

略

# 编程思想之状态机设计思想

略
